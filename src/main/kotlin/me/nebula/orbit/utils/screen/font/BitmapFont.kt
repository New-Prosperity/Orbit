package me.nebula.orbit.utils.screen.font

import me.nebula.orbit.utils.screen.canvas.MapCanvas
import me.nebula.orbit.utils.screen.texture.Texture

data class BitmapFont(
    val atlas: Texture,
    val charWidth: Int,
    val charHeight: Int,
    val columns: Int,
    val startChar: Char = ' ',
)

fun MapCanvas.drawText(font: BitmapFont, x: Int, y: Int, text: String, color: Int) {
    val r = (color shr 16) and 0xFF
    val g = (color shr 8) and 0xFF
    val b = color and 0xFF
    val a = (color ushr 24) and 0xFF
    val maxIndex = font.columns * (font.atlas.height / font.charHeight) - 1
    var cx = x
    for (ch in text) {
        val index = ch.code - font.startChar.code
        if (index !in 0..maxIndex) { cx += font.charWidth; continue }
        val atlasCol = index % font.columns
        val atlasRow = index / font.columns
        val sx = atlasCol * font.charWidth
        val sy = atlasRow * font.charHeight
        for (gy in 0 until font.charHeight) {
            for (gx in 0 until font.charWidth) {
                val atlasPx = font.atlas.pixels[(sy + gy) * font.atlas.width + (sx + gx)]
                if (atlasPx and 0xFF != 0) {
                    pixel(cx + gx, y + gy, (a shl 24) or (r shl 16) or (g shl 8) or b)
                }
            }
        }
        cx += font.charWidth
    }
}

fun textWidth(font: BitmapFont, text: String): Int = text.length * font.charWidth

val DEFAULT_FONT: BitmapFont by lazy {
    val w = 6
    val h = 8
    val cols = 16
    val rows = 6
    val atlasW = w * cols
    val atlasH = h * rows
    val pixels = IntArray(atlasW * atlasH)
    for (i in FONT_6X8_DATA.indices) {
        val charIndex = i / h
        val row = i % h
        val bits = FONT_6X8_DATA[i].toInt() and 0xFF
        val col = charIndex % cols
        val atlasRow = charIndex / cols
        val baseX = col * w
        val baseY = atlasRow * h + row
        for (bit in 0 until w) {
            if (bits and (1 shl (w - 1 - bit)) != 0) {
                pixels[baseY * atlasW + baseX + bit] = 0xFFFFFFFF.toInt()
            }
        }
    }
    BitmapFont(Texture(pixels, atlasW, atlasH), w, h, cols)
}

@Suppress("ktlint")
private val FONT_6X8_DATA = byteArrayOf(
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x20,0x20,0x20,0x20,0x20,0x00,0x20,0x00,
    0x50,0x50,0x50,0x00,0x00,0x00,0x00,0x00,
    0x50,0x50,-4,0x50,-4,0x50,0x50,0x00,
    0x20,0x78,-96,0x70,0x28,0x14,-16,0x20,
    0x00,0x44,0x08,0x10,0x20,0x44,0x00,0x00,
    0x20,0x50,0x50,0x20,0x54,0x48,0x34,0x00,
    0x10,0x20,0x40,0x00,0x00,0x00,0x00,0x00,
    0x10,0x20,0x40,0x40,0x40,0x20,0x10,0x00,
    0x40,0x20,0x10,0x10,0x10,0x20,0x40,0x00,
    0x00,0x44,0x28,0x10,0x28,0x44,0x00,0x00,
    0x00,0x20,0x20,-8,0x20,0x20,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x20,0x20,0x40,
    0x00,0x00,0x00,0x7C,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x00,
    0x00,0x04,0x08,0x10,0x20,0x40,0x00,0x00,
    0x38,0x44,0x4C,0x54,0x64,0x44,0x38,0x00,
    0x10,0x30,0x10,0x10,0x10,0x10,0x38,0x00,
    0x38,0x44,0x04,0x08,0x10,0x20,0x7C,0x00,
    0x38,0x44,0x04,0x18,0x04,0x44,0x38,0x00,
    0x08,0x18,0x28,0x48,0x7C,0x08,0x08,0x00,
    0x7C,0x40,0x78,0x04,0x04,0x44,0x38,0x00,
    0x18,0x20,0x40,0x78,0x44,0x44,0x38,0x00,
    0x7C,0x04,0x08,0x10,0x20,0x20,0x20,0x00,
    0x38,0x44,0x44,0x38,0x44,0x44,0x38,0x00,
    0x38,0x44,0x44,0x3C,0x04,0x08,0x30,0x00,
    0x00,0x00,0x20,0x00,0x00,0x20,0x00,0x00,
    0x00,0x00,0x20,0x00,0x00,0x20,0x20,0x40,
    0x08,0x10,0x20,0x40,0x20,0x10,0x08,0x00,
    0x00,0x00,0x7C,0x00,0x7C,0x00,0x00,0x00,
    0x40,0x20,0x10,0x08,0x10,0x20,0x40,0x00,
    0x38,0x44,0x04,0x08,0x10,0x00,0x10,0x00,
    0x38,0x44,0x5C,0x54,0x5C,0x40,0x3C,0x00,
    0x38,0x44,0x44,0x7C,0x44,0x44,0x44,0x00,
    0x78,0x44,0x44,0x78,0x44,0x44,0x78,0x00,
    0x38,0x44,0x40,0x40,0x40,0x44,0x38,0x00,
    0x78,0x44,0x44,0x44,0x44,0x44,0x78,0x00,
    0x7C,0x40,0x40,0x78,0x40,0x40,0x7C,0x00,
    0x7C,0x40,0x40,0x78,0x40,0x40,0x40,0x00,
    0x38,0x44,0x40,0x5C,0x44,0x44,0x3C,0x00,
    0x44,0x44,0x44,0x7C,0x44,0x44,0x44,0x00,
    0x38,0x10,0x10,0x10,0x10,0x10,0x38,0x00,
    0x04,0x04,0x04,0x04,0x44,0x44,0x38,0x00,
    0x44,0x48,0x50,0x60,0x50,0x48,0x44,0x00,
    0x40,0x40,0x40,0x40,0x40,0x40,0x7C,0x00,
    0x44,0x6C,0x54,0x54,0x44,0x44,0x44,0x00,
    0x44,0x64,0x54,0x4C,0x44,0x44,0x44,0x00,
    0x38,0x44,0x44,0x44,0x44,0x44,0x38,0x00,
    0x78,0x44,0x44,0x78,0x40,0x40,0x40,0x00,
    0x38,0x44,0x44,0x44,0x54,0x48,0x34,0x00,
    0x78,0x44,0x44,0x78,0x50,0x48,0x44,0x00,
    0x38,0x44,0x40,0x38,0x04,0x44,0x38,0x00,
    0x7C,0x10,0x10,0x10,0x10,0x10,0x10,0x00,
    0x44,0x44,0x44,0x44,0x44,0x44,0x38,0x00,
    0x44,0x44,0x44,0x44,0x44,0x28,0x10,0x00,
    0x44,0x44,0x44,0x54,0x54,0x6C,0x44,0x00,
    0x44,0x44,0x28,0x10,0x28,0x44,0x44,0x00,
    0x44,0x44,0x28,0x10,0x10,0x10,0x10,0x00,
    0x7C,0x04,0x08,0x10,0x20,0x40,0x7C,0x00,
    0x30,0x20,0x20,0x20,0x20,0x20,0x30,0x00,
    0x00,0x40,0x20,0x10,0x08,0x04,0x00,0x00,
    0x30,0x10,0x10,0x10,0x10,0x10,0x30,0x00,
    0x10,0x28,0x44,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x7C,0x00,
    0x20,0x10,0x08,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x38,0x04,0x3C,0x44,0x3C,0x00,
    0x40,0x40,0x58,0x64,0x44,0x64,0x58,0x00,
    0x00,0x00,0x38,0x44,0x40,0x44,0x38,0x00,
    0x04,0x04,0x34,0x4C,0x44,0x4C,0x34,0x00,
    0x00,0x00,0x38,0x44,0x7C,0x40,0x38,0x00,
    0x18,0x24,0x20,0x70,0x20,0x20,0x20,0x00,
    0x00,0x00,0x34,0x4C,0x44,0x3C,0x04,0x38,
    0x40,0x40,0x58,0x64,0x44,0x44,0x44,0x00,
    0x10,0x00,0x30,0x10,0x10,0x10,0x38,0x00,
    0x08,0x00,0x18,0x08,0x08,0x48,0x48,0x30,
    0x40,0x40,0x48,0x50,0x60,0x50,0x48,0x00,
    0x30,0x10,0x10,0x10,0x10,0x10,0x38,0x00,
    0x00,0x00,0x68,0x54,0x54,0x54,0x44,0x00,
    0x00,0x00,0x58,0x64,0x44,0x44,0x44,0x00,
    0x00,0x00,0x38,0x44,0x44,0x44,0x38,0x00,
    0x00,0x00,0x58,0x64,0x64,0x58,0x40,0x40,
    0x00,0x00,0x34,0x4C,0x4C,0x34,0x04,0x04,
    0x00,0x00,0x58,0x64,0x40,0x40,0x40,0x00,
    0x00,0x00,0x3C,0x40,0x38,0x04,0x78,0x00,
    0x20,0x20,0x70,0x20,0x20,0x24,0x18,0x00,
    0x00,0x00,0x44,0x44,0x44,0x4C,0x34,0x00,
    0x00,0x00,0x44,0x44,0x44,0x28,0x10,0x00,
    0x00,0x00,0x44,0x54,0x54,0x54,0x28,0x00,
    0x00,0x00,0x44,0x28,0x10,0x28,0x44,0x00,
    0x00,0x00,0x44,0x44,0x44,0x3C,0x04,0x38,
    0x00,0x00,0x7C,0x08,0x10,0x20,0x7C,0x00,
)
